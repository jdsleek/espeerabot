<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sentinel_Nexus — Admin</title>
  <style>
    :root { --bg: #0f1419; --card: #1a2332; --text: #e7e9ea; --muted: #8b98a5; --accent: #1d9bf0; --green: #00ba7c; --border: #2f3336; }
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 1rem; min-height: 100vh; }
    h1 { font-size: 1.5rem; margin: 0 0 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
    h1 a { color: var(--accent); text-decoration: none; }
    .sub { color: var(--muted); font-size: 0.875rem; margin-bottom: 1rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1rem 1.25rem; }
    .card h2 { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); margin: 0 0 0.5rem; }
    .card .value { font-size: 1.5rem; font-weight: 700; }
    .card .row { display: flex; justify-content: space-between; margin: 0.25rem 0; font-size: 0.9rem; }
    .card .row .muted { color: var(--muted); }
    .learnings { white-space: pre-wrap; font-size: 0.85rem; max-height: 200px; overflow-y: auto; color: var(--muted); }
    .learnings.empty { font-style: italic; }
    .state-json { font-size: 0.75rem; font-family: ui-monospace, monospace; white-space: pre-wrap; word-break: break-all; max-height: 180px; overflow-y: auto; color: var(--muted); }
    .live { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: var(--green); margin-right: 0.5rem; animation: pulse 2s infinite; }
    @keyframes pulse { 50% { opacity: 0.6; } }
    .error { color: #f4212e; font-size: 0.85rem; }
    .updated { color: var(--muted); font-size: 0.75rem; margin-top: 1rem; }
  </style>
</head>
<body>
  <h1><span class="live"></span> Sentinel_Nexus Admin</h1>
  <p class="sub">Live stats · <a href="https://www.moltbook.com/u/Sentinel_Nexus" target="_blank" rel="noopener">Profile on Moltbook</a> · Refresh every 30s</p>

  <div class="grid" id="grid"></div>
  <p class="updated" id="updated"></p>

  <script>
    const $ = (id) => document.getElementById(id);
    const grid = $("grid");
    const updated = $("updated");

    function escapeHtml(s) {
      const d = document.createElement("div");
      d.textContent = s;
      return d.innerHTML;
    }

    function render(data) {
      const m = data.moltbook || {};
      const agent = (m.agent || {});
      const stats = agent.stats || {};
      const state = data.state || {};

      grid.innerHTML = `
        <div class="card">
          <h2>Moltbook</h2>
          ${m.success
            ? `<div class="value">${escapeHtml(String(agent.karma ?? 0))} karma</div>
               <div class="row"><span class="muted">Posts</span><span>${escapeHtml(String(stats.posts ?? 0))}</span></div>
               <div class="row"><span class="muted">Comments</span><span>${escapeHtml(String(stats.comments ?? 0))}</span></div>
               <div class="row"><span class="muted">Subscriptions</span><span>${escapeHtml(String(stats.subscriptions ?? 0))}</span></div>
               <div class="row"><span class="muted">Last active</span><span>${escapeHtml(agent.last_active ? new Date(agent.last_active).toLocaleString() : "—")}</span></div>`
            : `<div class="error">${escapeHtml(m.error || "Not loaded")}</div>`}
        </div>
        <div class="card">
          <h2>OpenClaw state</h2>
          <div class="row"><span class="muted">Last Moltbook check</span><span>${escapeHtml(state.lastMoltbookCheck || "—")}</span></div>
          <div class="row"><span class="muted">Last post</span><span>${escapeHtml(state.lastPostAt || "—")}</span></div>
          <div class="row"><span class="muted">Last weekly recap</span><span>${escapeHtml(state.lastWeeklyRecapAt || "—")}</span></div>
          <div class="row"><span class="muted">Known followers</span><span>${escapeHtml(state.lastKnownFollowerCount != null ? String(state.lastKnownFollowerCount) : "—")}</span></div>
        </div>
        <div class="card" style="grid-column: 1 / -1;">
          <h2>Learnings (sentinel-learnings.md)</h2>
          <div class="learnings ${!data.learnings ? "empty" : ""}">${escapeHtml(data.learnings || "No learnings yet.")}</div>
        </div>
        <div class="card" style="grid-column: 1 / -1;">
          <h2>heartbeat-state.json (raw)</h2>
          <pre class="state-json">${escapeHtml(JSON.stringify(state, null, 2))}</pre>
        </div>
      `;
      updated.textContent = "Updated " + new Date().toLocaleTimeString();
    }

    function fetchStats() {
      fetch("/api/stats")
        .then((r) => r.json())
        .then(render)
        .catch((e) => {
          grid.innerHTML = `<div class="card" style="grid-column:1/-1;"><div class="error">Failed to load: ${escapeHtml(String(e.message))}. Is the server running on this port?</div></div>`;
        });
    }

    fetchStats();
    setInterval(fetchStats, 30000);
  </script>
</body>
</html>
