<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Full report — Jobmaster Agency</title>
  <style>
    :root { --bg: #0b0f14; --card: #141b24; --text: #e6edf3; --muted: #7d8590; --accent: #58a6ff; --green: #3fb950; --border: #30363d; }
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 1.5rem; max-width: 720px; margin-left: auto; margin-right: auto; line-height: 1.6; }
    h1 { font-size: 1.25rem; margin: 0 0 0.25rem; font-weight: 600; }
    .sub { color: var(--muted); font-size: 0.9rem; margin-bottom: 1.25rem; }
    .meta { font-size: 0.85rem; color: var(--muted); margin-bottom: 1.5rem; }
    .report-body { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; white-space: pre-wrap; font-size: 0.95rem; line-height: 1.65; }
    .report-body h2 { font-size: 1rem; margin: 1.25rem 0 0.5rem; color: var(--accent); }
    .report-body h2:first-child { margin-top: 0; }
    .nav { margin-top: 1.5rem; font-size: 0.9rem; }
    .nav a { color: var(--accent); }
    .empty { color: var(--muted); font-style: italic; }
    .badge { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600; background: rgba(63, 185, 80, 0.2); color: var(--green); }
    .feedback-box { margin-top: 1.5rem; padding: 1rem; background: var(--card); border: 1px solid var(--border); border-radius: 12px; }
    .feedback-box h3 { font-size: 0.9rem; margin: 0 0 0.5rem; color: var(--muted); }
    .feedback-box textarea { width: 100%; min-height: 80px; padding: 0.5rem; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.9rem; margin-bottom: 0.5rem; }
    .feedback-box button { padding: 0.4rem 0.8rem; background: var(--accent); color: var(--bg); border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .feedback-list { font-size: 0.85rem; color: var(--muted); margin-top: 0.5rem; }
    .revised-box { margin-top: 1rem; padding: 1rem; background: rgba(63, 185, 80, 0.08); border: 1px solid rgba(63, 185, 80, 0.3); border-radius: 12px; }
    .revised-box pre { white-space: pre-wrap; font-size: 0.9rem; margin: 0.5rem 0 0; }
    .user-header { border-bottom: 1px solid var(--border); padding-bottom: 1rem; margin-bottom: 1.5rem; }
    .user-header .brand { font-weight: 700; font-size: 1.1rem; text-decoration: none; color: var(--text); }
    .user-header .brand:hover { color: var(--accent); }
    .user-header .nav { font-size: 0.9rem; margin-top: 0.5rem; }
    .user-header .nav a { color: var(--muted); text-decoration: none; margin-right: 1rem; }
    .user-header .nav a:hover { color: var(--accent); }
  </style>
</head>
<body>
  <header class="user-header">
    <a href="/" class="brand">Jobmaster Agency</a>
    <nav class="nav" aria-label="Main"><a href="/">Home</a> <a href="/post-job">Post a job</a> <a href="/job/track">Track your job</a></nav>
  </header>
  <h1>Full report</h1>
  <p class="sub" id="sub">Loading…</p>
  <p class="meta" id="meta"></p>
  <div id="reportBox" class="report-body" style="display:none;"></div>
  <p id="noReport" class="empty" style="display:none;">No report yet. The job may still be in progress.</p>

  <div id="feedbackSection" class="feedback-box" style="display:none;">
    <h3>Send feedback (what to add or change?)</h3>
    <textarea id="feedbackInput" placeholder="e.g. Add more sources, focus on X, include links..."></textarea>
    <button type="button" id="feedbackBtn">Send feedback</button>
    <p id="feedbackStatus" class="feedback-list"></p>
    <div id="feedbackList" class="feedback-list"></div>
  </div>
  <div id="revisedSection" style="display:none; margin-top:1rem;">
    <button type="button" id="reviseBtn">Generate revised report from feedback</button>
    <p id="reviseStatus" style="font-size:0.85rem; color:var(--muted); margin-top:0.5rem;"></p>
  </div>
  <div id="revisedBox" class="revised-box" style="display:none;">
    <h3>Revised report (based on your feedback)</h3>
    <pre id="revisedContent"></pre>
  </div>

  <nav class="nav" style="margin-top:1.5rem;"><a href="/job/track" id="backTrack">← Track job</a> · <a href="/">Home</a> · <a href="/post-job">Post a job</a></nav>

  <script>
    (function() {
      const params = new URLSearchParams(window.location.search);
      const token = params.get("token");
      const sub = document.getElementById("sub");
      const meta = document.getElementById("meta");
      const reportBox = document.getElementById("reportBox");
      const noReport = document.getElementById("noReport");
      const backTrack = document.getElementById("backTrack");
      const feedbackSection = document.getElementById("feedbackSection");
      const feedbackInput = document.getElementById("feedbackInput");
      const feedbackBtn = document.getElementById("feedbackBtn");
      const feedbackStatus = document.getElementById("feedbackStatus");
      const feedbackList = document.getElementById("feedbackList");
      const revisedSection = document.getElementById("revisedSection");
      const reviseBtn = document.getElementById("reviseBtn");
      const reviseStatus = document.getElementById("reviseStatus");
      const revisedBox = document.getElementById("revisedBox");
      const revisedContent = document.getElementById("revisedContent");

      if (!token) {
        sub.textContent = "Missing tracking token. Open this page from your track link, e.g. /job/report?token=...";
        return;
      }
      backTrack.href = "/job/track?token=" + encodeURIComponent(token);

      function loadFeedback() {
        fetch("/api/job-feedback?token=" + encodeURIComponent(token))
          .then(function(r) { return r.json(); })
          .then(function(d) {
            const list = d.feedback || [];
            feedbackList.textContent = list.length ? "Previous feedback: " + list.map(function(f) { return f.feedback.slice(0, 60) + (f.feedback.length > 60 ? "…" : ""); }).join("; ") : "";
            if (list.length > 0) revisedSection.style.display = "block";
          });
      }
      function loadRevised() {
        fetch("/api/revised-report?token=" + encodeURIComponent(token))
          .then(function(r) { return r.json(); })
          .then(function(d) {
            if (d.revised) {
              revisedBox.style.display = "block";
              revisedContent.textContent = d.revised;
            }
          });
      }

      fetch("/api/job/track?token=" + encodeURIComponent(token))
        .then(function(r) { return r.json(); })
        .then(function(d) {
          if (d.error && d.status === "invalid") {
            sub.textContent = d.error || "Job not found.";
            return;
          }
          sub.textContent = d.title || "Report";
          const delivered = d.status === "delivered";
          if (delivered && d.deliveredAt) {
            meta.innerHTML = "Delivered " + new Date(d.deliveredAt).toLocaleString(undefined, { dateStyle: "medium", timeStyle: "short" });
            if (d.durationMinutes != null) meta.innerHTML += " · Completed in " + d.durationMinutes + " min";
            meta.innerHTML += " · <span class=\"badge\">Delivered</span>";
          } else {
            meta.textContent = "Status: " + (d.status || "—");
          }
          if (d.deliverable) {
            reportBox.style.display = "block";
            reportBox.textContent = d.deliverable;
          } else {
            noReport.style.display = "block";
          }
          if (d.status === "delivered") {
            feedbackSection.style.display = "block";
            loadFeedback();
            loadRevised();
          }
        })
        .catch(function(e) {
          sub.textContent = "Could not load report: " + e.message;
        });

      if (feedbackBtn) feedbackBtn.onclick = function() {
        const text = (feedbackInput && feedbackInput.value || "").trim();
        if (!text) return;
        feedbackBtn.disabled = true;
        feedbackStatus.textContent = "Sending…";
        fetch("/api/job-feedback", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ token: token, feedback: text }) })
          .then(function(r) { return r.json(); })
          .then(function(d) {
            feedbackStatus.textContent = d.ok ? "Feedback saved." : (d.error || "Error");
            if (d.ok) { feedbackInput.value = ""; loadFeedback(); revisedSection.style.display = "block"; }
            feedbackBtn.disabled = false;
          })
          .catch(function() { feedbackStatus.textContent = "Error"; feedbackBtn.disabled = false; });
      };
      if (reviseBtn) reviseBtn.onclick = function() {
        reviseBtn.disabled = true;
        reviseStatus.textContent = "Generating revised report (Kimi 2.5)…";
        fetch("/api/revise-report", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ token: token }) })
          .then(function(r) { return r.json(); })
          .then(function(d) {
            if (d.revised) {
              revisedBox.style.display = "block";
              revisedContent.textContent = d.revised;
              reviseStatus.textContent = "Done.";
            } else {
              reviseStatus.textContent = d.error || "Could not generate revised report.";
            }
            reviseBtn.disabled = false;
          })
          .catch(function() { reviseStatus.textContent = "Error"; reviseBtn.disabled = false; });
      };
    })();
  </script>
</body>
</html>
