<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Completed work — Jobmaster Admin</title>
  <style>
    :root { --bg: #0b0f14; --card: #141b24; --text: #e6edf3; --muted: #7d8590; --accent: #58a6ff; --green: #3fb950; --border: #30363d; }
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 1rem; min-height: 100vh; }
    h1 { font-size: 1.5rem; margin: 0 0 0.25rem; }
    .sub { color: var(--muted); font-size: 0.875rem; margin-bottom: 1rem; }
    .sub a { color: var(--accent); text-decoration: none; margin-right: 1rem; }
    .sub a:hover { text-decoration: underline; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: 1rem; }
    .card h2 { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.06em; color: var(--muted); margin: 0 0 0.75rem; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th, td { padding: 0.6rem 0.75rem; text-align: left; border-bottom: 1px solid var(--border); vertical-align: top; }
    th { color: var(--muted); font-weight: 600; }
    td a { color: var(--accent); text-decoration: none; }
    td a:hover { text-decoration: underline; }
    .deliverable { white-space: pre-wrap; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem; margin-top: 0.5rem; font-size: 0.85rem; line-height: 1.5; max-height: 200px; overflow-y: auto; color: var(--muted); }
    .deliverable-toggle { cursor: pointer; color: var(--accent); font-size: 0.8rem; }
    .muted { color: var(--muted); }
    .source-tag { font-size: 0.7rem; padding: 0.15rem 0.4rem; border-radius: 4px; background: var(--bg); color: var(--muted); }
    .empty { color: var(--muted); font-style: italic; }
    #setup-hint code { background: var(--card); padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.8rem; }
  </style>
</head>
<body>
  <h1>Completed work</h1>
  <nav class="sub">
    <a href="/admin/dashboard">Dashboard</a> ·
    <a href="/admin/workers">Workers</a> ·
    <a href="/admin/completed">Completed</a> ·
    <a href="/admin/analysis">Analysis</a> ·
    <a href="/admin/report-demo">Report demo</a> ·
    <a href="/">Public site →</a>
  </nav>

  <div class="card">
    <h2>All completed submissions</h2>
    <p id="loading" class="muted">Loading…</p>
    <div id="content" style="display:none;">
      <table>
        <thead>
          <tr>
            <th>Title</th>
            <th>Completed by</th>
            <th>Amount</th>
            <th>Completed at</th>
            <th>Track</th>
            <th>Link</th>
            <th>Deliverable</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <p id="empty" class="empty" style="display:none;">No completed work yet. Run cycles and approve submissions to see them here.</p>
      <div id="setup-hint" class="card" style="display:none; margin-top:1rem; background:var(--bg); border-color:var(--accent);">
        <h2 style="font-size:0.75rem;">Setup: same data as local</h2>
        <p class="muted" style="margin:0 0 0.5rem;">Completed work is loaded from ClawTasks using your agent credentials. On Railway, add the same credential files you use locally so this page shows the same data.</p>
        <p class="muted" style="margin:0; font-size:0.85rem;">Put <code>clawtasks-credentials.json</code> (and optional jobmaster2, jobmaster3 files) in the volume under <code>.openclaw/</code>. Path: <code id="cred-path-hint"></code></p>
      </div>
    </div>
    <p id="error" class="muted" style="display:none;"></p>
  </div>

  <script>
    function esc(s) {
      if (s == null || s === undefined) return "";
      const div = document.createElement("div");
      div.textContent = s;
      return div.innerHTML;
    }
    function formatDate(iso) {
      if (!iso) return "—";
      try {
        const d = new Date(iso);
        return d.toLocaleString(undefined, { dateStyle: "short", timeStyle: "short" });
      } catch { return iso; }
    }

    fetch("/api/completed-work")
      .then((r) => r.json())
      .then((data) => {
        document.getElementById("loading").style.display = "none";
        const list = data.completed || [];
        if (list.length === 0) {
          document.getElementById("content").style.display = "block";
          document.getElementById("empty").style.display = "block";
          if (data.noCredentials) {
            const setupHint = document.getElementById("setup-hint");
            setupHint.style.display = "block";
            const pathHint = document.getElementById("cred-path-hint");
            if (data.railwayVolume) {
              pathHint.textContent = data.railwayVolume + "/.openclaw/";
            } else if (data.openclawPath) {
              pathHint.textContent = data.openclawPath + "/";
            } else {
              pathHint.textContent = "(volume)/.openclaw/ or OPENCLAW_STATE_DIR";
            }
          }
          return;
        }
        document.getElementById("content").style.display = "block";
        const tbody = document.getElementById("tbody");
        list.forEach((row, i) => {
          const tr = document.createElement("tr");
          const deliverableId = "deliverable-" + i;
          let deliverableCell = "<span class=\"muted\">—</span>";
          if (row.deliverable) {
            const showByDefault = list.length <= 3;
            deliverableCell = "<span class=\"deliverable-toggle\" data-id=\"" + deliverableId + "\">" + (showByDefault ? "Hide" : "Show") + "</span>" +
              "<div id=\"" + deliverableId + "\" class=\"deliverable\" style=\"display:" + (showByDefault ? "block" : "none") + ";\">" + esc(row.deliverable) + "</div>";
          }
          const bountyId = row.id || row.bountyId || "";
          const hasToken = row.tracking_token && String(row.tracking_token).trim().length > 0;
          const trackHref = hasToken ? "/job/track?token=" + encodeURIComponent(row.tracking_token) : (bountyId ? "/admin/work?bountyId=" + encodeURIComponent(bountyId) : "#");
          const fullWorkHref = bountyId ? "/admin/work?bountyId=" + encodeURIComponent(bountyId) : "#";
          const trackCell = hasToken
            ? "<a href=\"" + esc(trackHref) + "\">Track</a> · <a href=\"" + esc(fullWorkHref) + "\">Full work</a>"
            : "<a href=\"" + esc(trackHref) + "\">Full work</a>";
          tr.innerHTML =
            "<td>" + esc((row.title || "").slice(0, 80)) + ((row.title || "").length > 80 ? "…" : "") + " <span class=\"source-tag\">" + esc(row.source || "") + "</span></td>" +
            "<td>" + esc(row.claimer_name) + "</td>" +
            "<td>" + esc(row.amount) + " USDC</td>" +
            "<td>" + esc(formatDate(row.completed_at)) + "</td>" +
            "<td>" + trackCell + "</td>" +
            "<td><a href=\"" + esc(row.bounty_url) + "\" target=\"_blank\" rel=\"noopener\">ClawTasks</a></td>" +
            "<td>" + deliverableCell + "</td>";
          tbody.appendChild(tr);
        });
        document.querySelectorAll(".deliverable-toggle").forEach((el) => {
          el.addEventListener("click", function() {
            const id = this.getAttribute("data-id");
            const div = document.getElementById(id);
            if (!div) return;
            if (div.style.display === "none") {
              div.style.display = "block";
              this.textContent = "Hide";
            } else {
              div.style.display = "none";
              this.textContent = "Show";
            }
          });
        });
      })
      .catch((e) => {
        document.getElementById("loading").style.display = "none";
        document.getElementById("error").style.display = "block";
        document.getElementById("error").textContent = "Could not load: " + e.message;
      });
  </script>
</body>
</html>
