<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analysis — Jobmaster Admin</title>
  <style>
    :root { --bg: #0b0f14; --card: #141b24; --text: #e6edf3; --muted: #7d8590; --accent: #58a6ff; --green: #3fb950; --orange: #d29922; --red: #f85149; --border: #30363d; }
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 1rem; min-height: 100vh; }
    h1 { font-size: 1.5rem; margin: 0 0 0.25rem; }
    h1 a { color: var(--accent); text-decoration: none; }
    .sub { color: var(--muted); font-size: 0.875rem; margin-bottom: 1rem; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: 1rem; }
    .card h2 { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.06em; color: var(--muted); margin: 0 0 0.75rem; }
    .card .row { display: flex; justify-content: space-between; margin: 0.35rem 0; font-size: 0.9rem; }
    .card .row .muted { color: var(--muted); }
    table.data { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    table.data th, table.data td { padding: 0.5rem 0.75rem; text-align: left; border-bottom: 1px solid var(--border); }
    table.data th { color: var(--muted); font-weight: 600; }
    .amount { font-weight: 600; color: var(--green); }
    .instant { color: var(--green); }
    .proposal { color: var(--orange); }
    .analysis-block { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; font-size: 0.9rem; line-height: 1.5; color: var(--text); white-space: pre-wrap; }
    .btn { display: inline-block; padding: 0.5rem 1rem; background: var(--accent); color: var(--bg); border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-right: 0.5rem; margin-top: 0.5rem; }
    .btn:hover { opacity: 0.9; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary { background: var(--green); }
    .btn-orange { background: var(--orange); color: var(--bg); }
    .updated { color: var(--muted); font-size: 0.75rem; margin-top: 1rem; }
    .agent-row { margin-bottom: 1rem; }
    .agent-name { font-weight: 600; color: var(--accent); }
    .agent-stat { font-size: 0.85rem; color: var(--muted); }
  </style>
</head>
<body>
  <h1>Jobmaster Admin — Analysis</h1>
  <nav class="sub">
    <a href="/admin/dashboard" style="color:var(--accent)">Dashboard</a> ·
    <a href="/admin/workers" style="color:var(--accent)">Workers</a> ·
    <a href="/admin/completed" style="color:var(--accent)">Completed</a> ·
    <a href="/admin/analysis" style="color:var(--accent)">Analysis</a> ·
    <a href="/admin/report-demo" style="color:var(--accent)">Report demo</a> ·
    <a href="/" style="color:var(--muted)">Public site →</a>
    <span style="color:var(--muted)"> · Lead view: all jobs, all agents</span>
  </nav>

  <div class="card">
    <h2>Lead analysis (share to admin)</h2>
    <div id="analysisSummary" class="analysis-block">Loading…</div>
    <p class="updated" id="updated"></p>
  </div>

  <div class="card">
    <h2>Summary</h2>
    <div class="row"><span class="muted">Instant to claim</span><span id="instantCount" class="instant">—</span></div>
    <div class="row"><span class="muted">Proposal to apply</span><span id="proposalCount" class="proposal">—</span></div>
    <div class="row"><span class="muted">Our bounties in progress</span><span id="totalPending">—</span></div>
    <div class="row"><span class="muted">Completed (all time)</span><span id="totalCompleted">—</span></div>
    <div class="row"><span class="muted">Earned (USDC)</span><span id="totalEarned" class="amount">—</span></div>
    <button class="btn btn-orange" id="submitProposalsBtn">Submit proposals now (all 3 agents, up to 30/hour)</button>
  </div>

  <div class="card">
    <h2>Open opportunities (not ours)</h2>
    <p class="row muted" style="font-size:0.8rem;">Instant = claim now. Proposal = submit proposal; poster picks winner.</p>
    <table class="data" id="openTable">
      <thead>
        <tr><th>Amount</th><th>Mode</th><th>Poster</th><th>Title</th><th>Action</th><th>Link</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <h2>All agents' jobs (lead sees everyone)</h2>
    <div id="agentsJobs"></div>
  </div>

  <script>
    function esc(s) {
      const d = document.createElement("div");
      d.textContent = s == null ? "" : s;
      return d.innerHTML;
    }
    function render(data) {
      if (!data) return;
      document.getElementById("analysisSummary").textContent = data.analysisSummary || "—";
      document.getElementById("instantCount").textContent = data.instantCount ?? "—";
      document.getElementById("proposalCount").textContent = data.proposalCount ?? "—";
      document.getElementById("totalPending").textContent = data.totalPending ?? "—";
      document.getElementById("totalCompleted").textContent = data.totalCompleted ?? "—";
      document.getElementById("totalEarned").textContent = (data.totalEarned != null ? data.totalEarned + " USDC" : "—");
      document.getElementById("updated").textContent = "Updated " + (data.updatedAt ? new Date(data.updatedAt).toLocaleString() : "");

      const tbody = document.querySelector("#openTable tbody");
      tbody.innerHTML = (data.openBounties || []).slice(0, 60).map((j) => `
        <tr>
          <td class="amount">${j.amount} USDC</td>
          <td class="${j.mode === "instant" ? "instant" : "proposal"}">${esc(j.mode)}</td>
          <td>${esc(j.poster_name || "")}</td>
          <td title="${esc(j.title)}">${esc(j.title.slice(0, 45))}${j.title.length > 45 ? "…" : ""}</td>
          <td>${j.canClaimInstant ? "Claim" : j.needProposal ? "Propose" : "—"}</td>
          <td><a href="https://clawtasks.com/bounty/${j.id}" target="_blank" rel="noopener">Open</a></td>
        </tr>
      `).join("");

      const agentsHtml = (data.agentsDetail || []).map((a) => {
        const work = (a.currentWork || []).map((w) => `<div><a href="${esc(w.link)}" target="_blank" rel="noopener">${esc(w.title)}</a> — ${esc(w.status)}</div>`).join("") || "—";
        const stats = a.stats ? `Earned ${a.stats.total_earned} USDC · ${a.stats.bounties_completed} completed` : "—";
        return `<div class="agent-row"><span class="agent-name">${esc(a.name)}</span> (${esc(a.role)}) ${!a.enabled ? "— Off" : ""}<div class="agent-stat">${stats}</div><div style="margin-top:0.35rem;">${work}</div></div>`;
      }).join("");
      document.getElementById("agentsJobs").innerHTML = agentsHtml || "—";
    }
    function fetchAnalysis() {
      fetch("/api/analysis")
        .then((r) => r.json())
        .then(render)
        .catch((e) => { document.getElementById("analysisSummary").textContent = "Error: " + e.message; });
    }
    document.getElementById("submitProposalsBtn").onclick = function() {
      const btn = this;
      btn.disabled = true;
      btn.textContent = "Submitting proposals…";
      fetch("/api/submit-proposals", { method: "POST" })
        .then((r) => r.json())
        .then((d) => {
          let msg = d.submitted ? "Submitted " + d.submitted + " proposals" : (d.error || "Done");
          if (d.byAgent && Object.keys(d.byAgent).length) msg += " (" + Object.entries(d.byAgent).map(([a, n]) => a + ": " + n).join(", ") + ")";
          btn.textContent = msg + " · Refresh";
          fetchAnalysis();
        })
        .catch((e) => { btn.textContent = "Error"; btn.disabled = false; });
    };
    fetchAnalysis();
    setInterval(fetchAnalysis, 20000);
  </script>
</body>
</html>
